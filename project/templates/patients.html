<!DOCTYPE html>
<html>
<head>
  <title>Patients Management</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>

<body class="p-4" style="background-color: #cce9f0;">
  <div class="container">
    <div class="p-4 mb-4 border rounded" style="background-image: url('/static/background_1/shield_generated.jpg'); background-size: cover; background-position: center;">
        <h1 class="display-4 fw-bold text-start" style="color: #cce9f0;">Patient</h1>
    </div>

    <!-- Search -->
    <div class="mb-4 row">
        <div class="col-auto">
            <input type="number" id="searchPatientID" placeholder="Enter Patient ID" class="form-control">
        </div>
        <div class="col-auto">
            <button type="button" id="searchButton" style="color: white; background-color: #030b58; padding: 0.5rem 1rem; border: none; border-radius: 3px;">Search</button>
        </div>
    </div>

   <!-- Patient Form -->
    <form id="patientForm" class="mb-4">
      <input type="hidden" id="patientID">
      <div class="row">
        <div class="col"><input type="text" id="firstname" class="form-control" placeholder="First Name" required></div>
        <div class="col"><input type="text" id="surname" class="form-control" placeholder="Surname" required></div>
        <div class="col"><input type="text" id="dob" class="form-control" placeholder="Date of Birth" required></div> 
        <script>flatpickr("#dob", {dateFormat: "d/m/Y"});</script> <!-- changing the date presentation on the form -->
      </div>
      <div class="row mt-2">
        <div class="col"><input type="text" id="address" class="form-control" placeholder="Address" required></div>
        <div class="col"><input type="text" id="city" class="form-control" placeholder="City" required></div>
        <div class="col"><input type="text" id="county" class="form-control" placeholder="County" required></div>
      </div>
      <div class="row mt-2">
        <div class="col"><input type="text" id="eir_code" class="form-control" placeholder="Eir Code"></div>
        <div class="col"><input type="text" id="phone" class="form-control" placeholder="Phone" required></div>
        <div class="col"><input type="email" id="email" class="form-control" placeholder="Email"></div>
        <div class="col"><input type="number" id="doctorID" class="form-control" placeholder="Doctor ID" required></div>
      </div>
      <button type="submit" id="saveButton" style="color: white; background-color: #030b58; padding: 0.5rem 1rem; border: none; border-radius: 3px;margin-top: 1rem;">
  Save</button>
    </form>

    <!-- Patient Table -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th><th>Name</th><th>DOB</th><th>Address</th><th>Phone</th><th>Email</th><th>Doctor ID</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="patientsTableBody"></tbody>
    </table>
  </div>

  <script>
    const apiUrl = "/api/patients";

    document.addEventListener("DOMContentLoaded", loadPatients);
    document.getElementById("patientForm").addEventListener("submit", savePatient);
    document.getElementById("searchButton").addEventListener("click", searchPatient);

    function formatDate(dateString) {         //converting the date string into format dd/mm/yyyy
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');   //getting the day and ensures it's 2 digits
        const month = String(date.getMonth() + 1).padStart(2, '0'); // getting the month, padding to 2 diggits (january = 0, so adding 1)
        const year = date.getFullYear();  //getting the year from string
        return `${day}/${month}/${year}`; 
    }   

    function loadPatients() {
      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          const table = document.getElementById("patientsTableBody");
          table.innerHTML = "";
          data.forEach(patient => {
            const formattedDOB = formatDate(patient.dob);
            table.innerHTML += `
              <tr>
                <td>${patient.patientID}</td>
                <td>${patient.firstname} ${patient.surname}</td>
                <td>${formatDate(patient.dob)}</td>  
                <td>${patient.address} ${patient.city} ${patient.county}</td>
                <td>${patient.phone}</td>
                <td>${patient.email}</td>
                <td>${patient.doctorID}</td>
                <td>
                  <button type="submit" id="editButton" style="color: white; background-color: #03583c;" onclick="editPatient(${patient.patientID})">Edit</button>
                  <button type="submit" id="deleteButton" style="color: white; background-color: #8d0c32;" onclick="deletePatient(${patient.patientID})">Delete</button>
                </td>
              </tr>
            `;
          });
        })
        .catch(err => alert("Error loading patients: " + err));
    }

    function savePatient(e) {
      e.preventDefault();

      const patientID = document.getElementById("patientID").value;
      const patientData = {
        firstname: document.getElementById("firstname").value,
        surname: document.getElementById("surname").value,
        dob: document.getElementById("dob")._flatpickr.selectedDates[0]?.toISOString().split("T")[0], //converting the full timestamp to the date format dd/mm/yyyy
        address: document.getElementById("address").value,
        city: document.getElementById("city").value,
        county: document.getElementById("county").value,
        eir_code: document.getElementById("eir_code").value,
        phone: document.getElementById("phone").value,
        email: document.getElementById("email").value,
        doctorID: document.getElementById("doctorID").value,
      };

      const method = patientID ? "PUT" : "POST";
      const url = patientID ? `${apiUrl}/${patientID}` : apiUrl;

      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patientData)
      })
      .then(res => {
        if (!res.ok) throw new Error("Failed to save");
        return res.json();
      })
      .then(() => {
        document.getElementById("patientForm").reset();
        loadPatients();
      })
      .catch(err => alert(err));
    }

    function editPatient(id) {
      fetch(`${apiUrl}/${id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("patientID").value = data.patientID;
          document.getElementById("firstname").value = data.firstname;
          document.getElementById("surname").value = data.surname;

          // Convert existing date string to yyyy-mm-dd (Flatpickr compatible)
          const date = new Date(data.dob);
          const formatted = date.toISOString().split("T")[0]; // '1985-05-11'
          document.getElementById("dob")._flatpickr.setDate(formatted);

          document.getElementById("dob").value = data.dob;
          document.getElementById("address").value = data.address;
          document.getElementById("city").value = data.city;
          document.getElementById("county").value = data.county;
          document.getElementById("eir_code").value = data.eir_code;
          document.getElementById("phone").value = data.phone;
          document.getElementById("email").value = data.email;
          document.getElementById("doctorID").value = data.doctorID;
        })
        .catch(err => alert("Error loading patient: " + err));
    }

    function deletePatient(id) {
      if (confirm("Are you sure you want to delete this patient?")) {
        fetch(`${apiUrl}/${id}`, { method: "DELETE" })
          .then(() => loadPatients())
          .catch(err => alert("Delete failed: " + err));
      }
    }

    function searchPatient() {
      const patientID = document.getElementById("searchPatientID").value;
      if (!patientID) {
        alert("Please enter a valid Patient ID.");
        return;
      }

      fetch(`${apiUrl}/${patientID}`)
        .then(response => {
          if (!response.ok) {
            throw new Error("Patient not found");
          }
          return response.json();
        })
        .then(data => {
          editPatient(data.patientID); // loads data into form
        })
        .catch(error => {
          alert(error.message);
        });
    }
  </script>
</body>
</html>
